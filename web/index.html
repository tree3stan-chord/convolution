<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convolution Reverb Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #00b4d8, #90e0ef);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            font-weight: 500;
        }

        .status.loading {
            color: #90e0ef;
            border: 1px solid #90e0ef;
        }

        .status.ready {
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        .status.error {
            color: #f87171;
            border: 1px solid #f87171;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .control-group:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: #90e0ef;
            font-size: 1.2em;
        }

        .control {
            margin-bottom: 15px;
        }

        .control label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #cae9ff;
        }

        .control input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        .control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00b4d8, #90e0ef);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(144, 224, 239, 0.5);
        }

        .control select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e0e0e0;
            font-size: 0.9em;
            cursor: pointer;
        }

        .control .value {
            display: inline-block;
            margin-left: 10px;
            font-size: 0.85em;
            color: #90e0ef;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .button {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button.primary {
            background: linear-gradient(45deg, #00b4d8, #90e0ef);
            color: #0f0f1a;
        }

        .button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 180, 216, 0.3);
        }

        .button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .button.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .visualizer {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .visualizer canvas {
            width: 100%;
            height: 200px;
            border-radius: 10px;
        }

        .info {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info h3 {
            color: #90e0ef;
            margin-bottom: 10px;
        }

        .info p {
            line-height: 1.6;
            color: #cae9ff;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .loading-indicator {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Convolution Reverb Explorer</h1>
        
        <div id="status" class="status loading">
            <span class="loading-indicator">Initializing WebAssembly module...</span>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>Reverb Parameters</h3>
                <div class="control">
                    <label>Room Size <span class="value" id="roomSizeValue">50</span>%</label>
                    <input type="range" id="roomSize" min="0" max="100" value="50">
                </div>
                <div class="control">
                    <label>Decay Time <span class="value" id="decayTimeValue">2.5</span>s</label>
                    <input type="range" id="decayTime" min="0.1" max="10" step="0.1" value="2.5">
                </div>
                <div class="control">
                    <label>Pre-Delay <span class="value" id="preDelayValue">20</span>ms</label>
                    <input type="range" id="preDelay" min="0" max="100" value="20">
                </div>
            </div>

            <div class="control-group">
                <h3>Tone Control</h3>
                <div class="control">
                    <label>High Frequency Damping <span class="value" id="dampingValue">50</span>%</label>
                    <input type="range" id="damping" min="0" max="100" value="50">
                </div>
                <div class="control">
                    <label>Low Frequency Response <span class="value" id="lowFreqValue">50</span>%</label>
                    <input type="range" id="lowFreq" min="0" max="100" value="50">
                </div>
                <div class="control">
                    <label>Diffusion <span class="value" id="diffusionValue">80</span>%</label>
                    <input type="range" id="diffusion" min="0" max="100" value="80">
                </div>
            </div>

            <div class="control-group">
                <h3>Mix Control</h3>
                <div class="control">
                    <label>Dry/Wet Mix <span class="value" id="mixValue">30</span>%</label>
                    <input type="range" id="mix" min="0" max="100" value="30">
                </div>
                <div class="control">
                    <label>Early Reflections <span class="value" id="earlyReflectionsValue">50</span>%</label>
                    <input type="range" id="earlyReflections" min="0" max="100" value="50">
                </div>
                <div class="control">
                    <label>Impulse Response</label>
                    <select id="impulseResponse">
                        <option value="hall">Concert Hall</option>
                        <option value="cathedral">Cathedral</option>
                        <option value="room">Small Room</option>
                        <option value="plate">Plate Reverb</option>
                        <option value="spring">Spring Reverb</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="button primary" id="liveInputButton">Start Live Input</button>
            <button class="button primary" id="processButton" disabled>Process Audio</button>
            <button class="button secondary" id="loadAudioButton">Load Audio File</button>
            <button class="button secondary" id="resetButton">Reset Parameters</button>
        </div>

        <input type="file" id="audioFileInput" accept="audio/*" style="display: none;">

        <div class="visualizer">
            <canvas id="waveformCanvas"></canvas>
        </div>

        <div class="info">
            <h3>About Convolution Reverb</h3>
            <p>
                This web application demonstrates convolution-based reverb processing using a Fortran engine compiled to WebAssembly. 
                The app starts with <strong>live microphone input</strong> by default - speak or play an instrument to hear the reverb in real-time!
            </p>
            <p style="margin-top: 10px;">
                You can also load and process audio files. Convolution reverb works by mathematically combining an input signal with an impulse response (IR) - 
                a recording of how a real space responds to sound. Adjust the parameters above to explore different reverb characteristics.
            </p>
            <p style="margin-top: 10px;">
                <strong>Note:</strong> For best results with live input, use headphones to avoid feedback. The implementation uses a simplified convolution 
                algorithm optimized for WebAssembly performance.
            </p>
        </div>
    </div>

    <script>
        // Simulated WebAssembly module interface
        let wasmModule = null;
        let audioContext = null;
        let currentBuffer = null;

        // Initialize audio context
        function initAudioContext() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        // Simulate WebAssembly module loading
        async function loadWasmModule() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    wasmModule = {
                        processConvolution: (inputBuffer, irBuffer, params) => {
                            // This would call the actual Fortran convolution function
                            console.log('Processing convolution with params:', params);
                            return inputBuffer; // Placeholder
                        },
                        setParameter: (param, value) => {
                            console.log(`Setting ${param} to ${value}`);
                        }
                    };
                    resolve();
                }, 1500);
            });
        }

        // Update parameter display values
        const parameterElements = {
            roomSize: document.getElementById('roomSize'),
            decayTime: document.getElementById('decayTime'),
            preDelay: document.getElementById('preDelay'),
            damping: document.getElementById('damping'),
            lowFreq: document.getElementById('lowFreq'),
            diffusion: document.getElementById('diffusion'),
            mix: document.getElementById('mix'),
            earlyReflections: document.getElementById('earlyReflections')
        };

        const valueElements = {
            roomSize: document.getElementById('roomSizeValue'),
            decayTime: document.getElementById('decayTimeValue'),
            preDelay: document.getElementById('preDelayValue'),
            damping: document.getElementById('dampingValue'),
            lowFreq: document.getElementById('lowFreqValue'),
            diffusion: document.getElementById('diffusionValue'),
            mix: document.getElementById('mixValue'),
            earlyReflections: document.getElementById('earlyReflectionsValue')
        };

        // Add event listeners for parameter changes
        Object.keys(parameterElements).forEach(param => {
            parameterElements[param].addEventListener('input', (e) => {
                const value = e.target.value;
                valueElements[param].textContent = value;
                
                if (wasmModule) {
                    wasmModule.setParameter(param, parseFloat(value));
                }
            });
        });

        // File input handling
        document.getElementById('loadAudioButton').addEventListener('click', () => {
            document.getElementById('audioFileInput').click();
        });

        document.getElementById('audioFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    currentBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    document.getElementById('processButton').disabled = false;
                    drawWaveform(currentBuffer);
                } catch (error) {
                    console.error('Error loading audio file:', error);
                    alert('Error loading audio file. Please try a different file.');
                }
            }
        });

        // Process button
        document.getElementById('processButton').addEventListener('click', () => {
            if (currentBuffer && wasmModule) {
                const params = {
                    roomSize: parseFloat(parameterElements.roomSize.value),
                    decayTime: parseFloat(parameterElements.decayTime.value),
                    preDelay: parseFloat(parameterElements.preDelay.value),
                    damping: parseFloat(parameterElements.damping.value),
                    lowFreq: parseFloat(parameterElements.lowFreq.value),
                    diffusion: parseFloat(parameterElements.diffusion.value),
                    mix: parseFloat(parameterElements.mix.value),
                    earlyReflections: parseFloat(parameterElements.earlyReflections.value),
                    impulseResponse: document.getElementById('impulseResponse').value
                };

                // Process audio through WebAssembly module
                const processedBuffer = wasmModule.processConvolution(
                    currentBuffer.getChannelData(0),
                    null, // IR buffer would be loaded based on selection
                    params
                );

                // Play processed audio
                const source = audioContext.createBufferSource();
                source.buffer = currentBuffer; // Would use processedBuffer in real implementation
                source.connect(audioContext.destination);
                source.start();
            }
        });

        // Reset button
        document.getElementById('resetButton').addEventListener('click', () => {
            const defaults = {
                roomSize: 50,
                decayTime: 2.5,
                preDelay: 20,
                damping: 50,
                lowFreq: 50,
                diffusion: 80,
                mix: 30,
                earlyReflections: 50
            };

            Object.keys(defaults).forEach(param => {
                parameterElements[param].value = defaults[param];
                valueElements[param].textContent = defaults[param];
                if (wasmModule) {
                    wasmModule.setParameter(param, defaults[param]);
                }
            });
        });

        // Waveform visualization
        function drawWaveform(audioBuffer) {
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            const data = audioBuffer.getChannelData(0);
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#90e0ef';
            ctx.lineWidth = 2;
            
            const sliceWidth = canvas.width / data.length;
            let x = 0;
            
            ctx.beginPath();
            for (let i = 0; i < data.length; i += Math.ceil(data.length / 1000)) {
                const y = (1 + data[i]) * canvas.height / 2;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth * Math.ceil(data.length / 1000);
            }
            ctx.stroke();
        }

        // Initialize application
        async function init() {
            try {
                initAudioContext();
                await loadWasmModule();
                
                const statusElement = document.getElementById('status');
                statusElement.className = 'status ready';
                statusElement.innerHTML = 'WebAssembly module loaded successfully!';
                
                // Draw empty waveform
                const canvas = document.getElementById('waveformCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                ctx.strokeStyle = '#90e0ef';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, canvas.height / 2);
                ctx.lineTo(canvas.width, canvas.height / 2);
                ctx.stroke();
                
            } catch (error) {
                const statusElement = document.getElementById('status');
                statusElement.className = 'status error';
                statusElement.innerHTML = 'Error loading WebAssembly module';
                console.error('Initialization error:', error);
            }
        }

        // Start initialization when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>